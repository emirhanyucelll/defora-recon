name: Daily Recon Update (External Trigger)

on:
  workflow_dispatch: # Sadece dışarıdan tetiklenebilir

permissions:
  contents: write

jobs:
  update-db:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Setup PHP Environment
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        extensions: mbstring, curl, zip, xml, json
        ini-values: memory_limit=-1, max_execution_time=0

    - name: Prepare Workspace
      run: |
        mkdir -p storage/raw
        mkdir -p shards
        chmod -R 777 storage shards

    - name: Execute Surgical Sync
      run: php -d memory_limit=-1 daily_sync.php normal

    - name: Cleanup Temporary Files
      run: rm -rf storage/raw/*

    - name: Commit and Push Database Update
      run: |
        git config --global user.name "DeforaBot"
        git config --global user.email "bot@defora.recon"
        git add shards/*.json last_sync.txt
        git commit -m "Auto-sync vulnerability database [$(date +'%Y-%m-%d %H:%M')]" || echo "Veri degisikligi yok."
        git push